var panorama,map,singleAllLayers,intLayersString,overlaysOBJ,tematikGroup,rencanaGroup,citrafotoGroup,container_popup,content_popup,closer_popup,overlay_popup,geolocation,template=Handlebars.compile($("#details-infomap-template").html()),infoLayer="all",infomap="info",intLayers=[],selectedLayer="all",searchLayer="geodata:survei",searchObject="",layer_global=[],pureCoverage=!1,DefaultCoordinate=[114.454566, 1.551875],provinsi=$("select#provinsi"),kabkota=$("select#kabkota"),kecamatan=$("select#kecamatan"),desa=$("select#desa"),bogorselatanbounds=[106.88851400971271,-6.594783661681163,106.71582266449786,-6.680039062359272],bounds=[690359.8909999998,9261356.9862,704368.5469000004,9279460.6045],basemapTile=new ol.layer.Tile({source:new ol.source.TileImage({ url: 'http://mt1.google.com/vt/lyrs=s&hl=pl&&x={x}&y={y}&z={z}' }),name:"BaseMap Image Esri",id:"basemap",isBasemap:!0}),__root__=new ol.layer.Tile({visible:!0,source:new ol.source.TileWMS({url:window.Laravel.geoserverUrl+"/wms",params:{FORMAT:"image/png",VERSION:"1.1.1",tiled:!0,LAYERS:"pandeglang:admin_prov",STYLES:""}})});function get(e){if("undefined"!=typeof Storage)return localStorage.getItem(e);window.alert("Please use a modern browser to properly view this template!")}function store(e,t){"undefined"!=typeof Storage?localStorage.setItem(e,t):window.alert("Please use a modern browser to properly view this template!")}function initializePanorama(e){null==e?(lat=-6.6033115,lng=106.798036):(lat=e[1],lng=e[0]),panorama=new google.maps.StreetViewPanorama(document.getElementById("street-view"),{position:{lat:lat,lng:lng},pov:{heading:165,pitch:0},zoom:1})}function initMap(){tematikGroup=new ol.layer.Group({layers:[],name:"Tematik",id:"tematik"}),rencanaGroup=new ol.layer.Group({layers:[],name:"Rencana",id:"rencana"}),citrafotoGroup=new ol.layer.Group({layers:[],name:"Citra Foto",id:"citra"});var e=new ol.control.ScaleLine,t=new ol.control.OverviewMap({className:"ol-overviewmap ol-custom-overviewmap",layers:[new ol.layer.Tile({source:new ol.source.OSM})],collapseLabel:"»",label:"«",collapsed:!0});vectorSource=new ol.source.Vector;var a=new ol.layer.Vector({name:"Layer Vector",id:"lyr_vector",source:vectorSource,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})});map=new ol.Map({layers:[basemapTile,tematikGroup,rencanaGroup,citrafotoGroup,a],target:"map",view:new ol.View({center:ol.proj.fromLonLat(DefaultCoordinate),zoom:5,minZoom:5,maxZoom:19}),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}).extend([new basemapTools.basemapControl,t,e])});var o=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(2),projection:"EPSG:4326",target:document.getElementById("myposition"),undefinedHTML:"&nbsp;"});map.addControl(o),(geolocation=new ol.Geolocation({projection:map.getView().getProjection()})).on("change",function(){console.log("accuracy",geolocation.getAccuracy()+" [m]"),console.log("altitude",geolocation.getAltitude()+" [m]"),console.log("altitudeAccuracy",geolocation.getAltitudeAccuracy()+" [m]"),console.log("heading",geolocation.getHeading()+" [rad]"),console.log("speed",geolocation.getSpeed()+" [m/s]"),console.log("position",geolocation.getPosition())}),geolocation.on("error",function(e){var t=document.getElementById("info");t.innerHTML=e.message,t.style.display="",console.log("info",e.message)});var r=new ol.Feature;geolocation.on("change:accuracyGeometry",function(){r.setGeometry(geolocation.getAccuracyGeometry())});var l=new ol.Feature;l.setStyle(new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"#3399CC"}),stroke:new ol.style.Stroke({color:"#fff",width:2})})})),geolocation.on("change:position",function(){var e=geolocation.getPosition();l.setGeometry(e?new ol.geom.Point(e):null)});var i=findBy(map.getLayerGroup(),"id","lyr_vector").getSource();i.addFeature(r),i.addFeature(l);var n=new Geocoder("nominatim",{provider:"osm",key:"__some_key__",lang:"en-US",placeholder:"Pencarian for ...",targetType:"text-input",limit:5,keepOpen:!0});map.addControl(n),n.on("addresschosen",function(e){e.bbox?map.getView().fit(e.bbox,{duration:500}):map.getView().animate({zoom:14,center:e.coordinate})}),console.log(map.getView().calculateExtent()),console.log("getbound",map.getView().calculateExtent(map.getSize()))}function initPopup(){container_popup=document.getElementById("popup"),content_popup=document.getElementById("popup-content"),closer_popup=document.getElementById("popup-closer"),overlay_popup=new ol.Overlay({element:container_popup,autoPan:!0,autoPanAnimation:{duration:250}}),closer_popup.onclick=function(){return overlay_popup.setPosition(void 0),closer_popup.blur(),!1},map.addOverlay(overlay_popup)}function bindInputs(e,t){var a=$(e+" input.visible");a.on("change",function(){t.setVisible(this.checked)}),a.prop("checked",t.getVisible()),t.getVisible()?$(a).parent().parent().find("div.control-right").show():$(a).parent().parent().find("div.control-right").hide();var o=$(e+" input.opacity");o.on("input change",function(){t.setOpacity(parseFloat(this.value))}),o.val(String(t.getOpacity()))}function identifyLayer(e){e=e||"all";var t=$("select#identify");if(0<t.length){for(var a='<option value="all">All..</option>',o=0;o<intLayers.length;o++){var r=intLayers;a+='<option value="'+r[o]+'">'+r[o]+"</option>"}t.html(a),t.change(function(e){""!=(selectedLayer=$(this).val())||(selectedLayer="all")})}info_event=map.on("click",identifyLayerEvent)}function identifyLayerEvent(o){map.getFeaturesAtPixel(o.pixel);if("all"==selectedLayer)var e=__root__.getSource().getGetFeatureInfoUrl(o.coordinate,map.getView().getResolution(),map.getView().getProjection(),{INFO_FORMAT:"application/json",QUERY_LAYERS:intLayersString,LAYERS:intLayersString,FEATURE_COUNT:1e3});else e=findBy(map.getLayerGroup(),"id",selectedLayer).getSource().getGetFeatureInfoUrl(o.coordinate,map.getView().getResolution(),map.getView().getProjection(),{INFO_FORMAT:"application/json",FEATURE_COUNT:50});$.ajax({url:e,dataType:"json",error:function(e){console.log(e)},beforeSend:function(){$("#loading").html("<img src='images/ajax-loader.gif' />")}}).done(function(e){var t=e.features;content=template();t.properties,o.coordinate;$("#formModalMap").find(".modal-title").html("Informasi"),$("#formModalMap").find(".modal-body").html(content);var a=$("#carousel-popup").carousel();$("#carousel-popup").find(".carousel-infotable").html(tablePopupItem(t)),$("#formModalMap").modal(),a.bind("slide.bs.carousel",function(e){console.log($(".active",e.target).index())})}).fail(function(e){DevExpress.ui.notify("Gagal Meminta Request","error",600)})}function updateInteractiveLayers(e){var t=$.inArray(e,intLayers);-1<t?intLayers.splice(t,1):intLayers.push(e),intLayersString=intLayers.join(",")}function findBy(e,t,a){if(e.get(t)===a)return e;if(e.getLayers)for(var o,r=e.getLayers().getArray(),l=r.length,i=0;i<l;i++)if(o=findBy(r[i],t,a))return o;return null}function objLayer(e){if(e){layer_global=new ol.Collection,document.createElement("ul").setAttribute("class","list-group");for(var t=0;t<e.length;t++){var a,o=e[t],r=($($("#layercontrol").find("ul")[t]).attr("data-kodegroup"),$("#layercontrol").find(".panel").find("ul")[t],buildLayer(o));if($(r).appendTo($("#layercontrol").find(".panel").find("ul#list-group-"+o.kodegroup.split(":")[1])),a=e[t].urllayer,"olimage"==e[t].tipelayer){var l=new ol.layer.Image({source:new ol.source.ImageWMS({ratio:1,url:a,params:{FORMAT:"image/png",VERSION:"1.1.1",LAYERS:e[t].kodelayer}}),name:e[t].namalayer,id:e[t].kodelayer,visible:e[t].option_visible,opacity:e[t].option_opacity});layer_global.push(l),singleAllLayers=l}else{var i=new ol.source.TileWMS({url:a,params:{LAYERS:e[t].kodelayer,VERSION:"1.1.1",FORMAT:"image/png",STYLES:e[t].option_style,crossOrigin:"anonymous",serverType:"geoserver",tiled:!0}}),n=new ol.layer.Tile({source:i,visible:e[t].option_visible,opacity:e[t].option_opacity,name:e[t].namalayer,id:e[t].kodelayer,srs:e[t].srs||"EPSG:4326"});layer_global.push(n),singleAllLayers=n}updateInteractiveLayers(e[t].kodelayer)}tematikGroup.setLayers(layer_global)}}function tablePopup(e){if(e){var t="<div id='myCarousel' class='carousel slide' data-ride='carousel'>";if(t+="<div class='carousel-inner' style='max-height: 70vh;overflow-y: scroll;'>",0<e.length)for(var a in e){for(var o in t+=0==a?"<div class='panel panel-default item active table-layout'>":"<div class='panel panel-default item table-layout'>",t+="<div class='panel-heading'><h6 class='panel-title'><i class='icon-accessibility'></i><b><a href='#"+e[a].id+"' class='collapsed'>"+e[a].id+"</a></b></h6><div class='panel-toolbar text-right'><div class='btn-group'><button class='btn btn-sm btn-default btn-popup-close'><i class='ico-close4'></i></button></div></div></div>",t+="<div id='"+e[a].id.split(".")[0]+"' class='panel-collapse collapse in'>",t+="<div class='panel-body' class='max-height: 70vh;overflow-y: scroll;'>",t+="<table class='table table-striped'>",e[a].properties){var r=e[a].properties;console.log(o),"image_link"==o||"IMAGE_LINK"==o||"foto"==o||"FOTO"==o||"Foto"==o?t+="<tr><td><b>"+o+"</b></td><td><b>:</b> </td><td><image class='img-responsive' src='"+Laravel.serverUrl+"/files/uploads/asetkota/"+r[o]+"' width='100'/></td></tr>":"video"==o?t+="<tr><td><b>"+o+"</b></td><td><b>:</b> </td><td><video width='100%' autoplay loop preload ><source src='"+r[o]+"' type='video/mp4'>Your browser does not support HTML5 video.</video></td></tr>":"bbox"==o||(t+="<tr><td><b>"+o+"</b></td><td><b>:</b> </td><td>"+r[o]+"</td></tr>")}t+="</table>",t+="</div>",t+="</div>",t+="</div>"}else t+="<table class='table table-bordered'>",t+="<tr><td colspan=3>Data tidak ada</td></tr>",t+="</table>";t+="</div>",t+="</div>"}else{t="<table class='table table-bordered'>";t+="<tr><td>Data tidak ada</td></tr>",t+="</table>"}return t}function tablePopupItem(e){console.log(e);var t="";if(e)if(0<e.length)for(var a in e){var o=e[a].id,r=sendData(Laravel.serverUrl+"/api/getlayerinformasi/kotabogor:"+o.split(".")[0],'','GET',function(a){r=a});if(t+=0==a?"<div class='carousel-item active'>":"<div class='carousel-item'>",t+="<table class='table table-striped'>",null!==r.id&&r.hasOwnProperty("keydata")){var l=JSON.parse(r.keydata);for(i in l){var n=l[i],s=e[a].properties;n.visible&&("image"==n.fieldType?t+="<tr><td><b>"+n.label+"</b></td><td><b>:</b> </td><td><image class='img-responsive' src='"+Laravel.serverUrl+"/files/uploads/asetkota/"+s[n.fieldName]+"' width='200'/></td></tr>":"video"==n.fieldType?t+="<tr><td><b>"+n.label+"</b></td><td><b>:</b> </td><td><video width='100%' autoplay loop preload ><source src='"+Laravel.serverUrl+"/files/uploads/video/"+s[n.fieldName]+"' type='video/mp4'><source src='"+Laravel.serverUrl+"/files/uploads/video/"+s[n.fieldName]+"' type='video/webm'>Your browser does not support HTML5 video.</video></td></tr>":"sertifikat"==n.fieldType?t+="<tr><td><b>"+n.label+"</b></td><td><b>:</b> </td><td><image class='img-responsive' src='"+Laravel.serverUrl+"/files/uploads/sertifikat/"+s[n.fieldName]+"' width='200'/></td></tr>":t+="<tr><td><b>"+n.label+"</b></td><td><b>:</b> </td><td>"+s[n.fieldName]+"</td></tr>")}}else for(var d in t+="<tr><th>"+o.split(".")[0]+"</th></tr>",e[a].properties){s=e[a].properties;"image_link"==d||"IMAGE_LINK"==d||"foto"==d||"FOTO"==d||"URL_PHOTO"==d||"sertifikat"==d||"Foto"==d?t+="<tr><td><b>"+d.replace("_"," ")+"</b></td><td><b>:</b> </td><td><image class='img-responsive' src='"+Laravel.serverUrl+"/files/uploads/asetkota/"+s[d]+"' width='200'/></td></tr>":"video"==d?t+="<tr><td><b>"+d+"</b></td><td><b>:</b> </td><td><video width='100%' autoplay loop preload ><source src='"+Laravel.serverUrl+"/files/uploads/video/"+s[d]+"' type='video/mp4'><source src='"+Laravel.serverUrl+"/files/uploads/video/"+s[d]+"' type='video/webm'>Your browser does not support HTML5 video.</video></td></tr>":"lampiran"==d||"sertifikat"==d?t+="<tr><td><b>"+d.replace("_"," ")+"</b></td><td><b>:</b> </td><td><image class='img-responsive' src='"+Laravel.serverUrl+"/files/uploads/sertifikat/"+s[d]+"' width='200'/></td></tr>":"bbox"==d||d.includes("_id")||d.includes("id_")||d.includes("_ID")||d.includes("ID_")||d.includes("ID")||d.includes("id")||(t+="<tr><td><b>"+d.replace("_"," ")+"</b></td><td><b>:</b> </td><td>"+s[d]+"</td></tr>")}t+="</table>",t+="</div>"}else t+="<table class='table table-bordered'>",t+="<tr><td colspan=3>Data tidak ada</td></tr>",t+="</table>";return t}function initializeTree(){var e=buildLayerTree(map.getLayerGroup());$("#layertree").empty().append(e),$(".tree li:has(ul)").addClass("parent_li").find(" > span").attr("title","Collapse this branch"),$(".tree li.parent_li > span").on("click",function(e){var t=$(this).parent("li.parent_li").find(" > ul > li");t.is(":visible")?(t.hide("fast"),$(this).attr("title","Expand this branch").find(" > i").addClass("fa fa-plus-square").removeClass("glyphicon-minus")):(t.show("fast"),$(this).attr("title","Collapse this branch").find(" > i").addClass("fa fa-minus-square").removeClass("glyphicon-plus")),e.stopPropagation()})}function buildLayerTree(e){var t,a=e.get("name")?e.get("name"):"Group",o=e.get("id"),r=(document.createElement("li"),"<li class='list-group-item' id='layer-1-"+o+"'> <label for='visible_"+o+"'><input type='checkbox' id='visible_"+o+"' class='visible'>"+a+"</label><div class='btn btn-group control-right'><span class='btn btn-primary btn-xs transparan'>Transparan</span><span class='btn btn-success btn-xs legenda'>Legenda</span></div><fieldset id='opacity'><input class='opacity' type='range' min='0' max='1' step='0.01'/></fieldset><fieldset id='legend'><img src='/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=pandeglang:batas_kab' alt='Legenda'></fieldset>");if(e.getLayers){for(var l="",i=e.getLayers().getArray(),n=i.length-1;0<=n;n--)l+=buildLayerTree(i[n]);t=r+" <ul>"+l+"</ul></li>"}else t=r+" </li>";return t}function buildLayer(e){var t=document.createElement("li");t.setAttribute("class","list-group-item"),t.setAttribute("id","layer-1-"+e.kodelayer.split(":")[1]);var a=document.createElement("label");a.setAttribute("for","visible_"+e.kodelayer.split(":")[1]);var o=document.createElement("input");o.setAttribute("type","checkbox"),o.setAttribute("id","visible_"+e.kodelayer.split(":")[1]),o.setAttribute("class","visible"),a.append(o),a.append(" "+e.namalayer),t.append(a);var r=document.createElement("div");r.setAttribute("class","btn btn-group control-right");var l=document.createElement("span");l.setAttribute("class","btn btn-primary btn-xs transparan"),l.innerHTML="Transparan",r.append(l);var i=document.createElement("span");i.setAttribute("class","btn btn-success btn-xs legenda"),i.innerHTML="Legenda",r.append(i);var n=document.createElement("span");n.setAttribute("class","btn btn-info btn-xs zoom"),n.setAttribute("data-layer",e.kodelayer),n.innerHTML="Zoom",r.append(n),t.append(r);var s=document.createElement("fieldset");s.setAttribute("id","opacity"),s.setAttribute("style","display:none");var d=document.createElement("input");d.setAttribute("class","opacity"),d.setAttribute("type","range"),d.setAttribute("min","0"),d.setAttribute("max","1"),d.setAttribute("step","0.01"),s.append(d),t.append(s);var p=document.createElement("fieldset");p.setAttribute("id","legend"),p.setAttribute("style","display:none");var c=document.createElement("img");return c.setAttribute("src",Laravel.geoserverUrl+"/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER="+e.kodelayer),c.setAttribute("alt","Legenda"),p.append(c),t.append(p),t.addEventListener("click",layerclickEvent),t}function layerclickEvent(e){if($(e.target).hasClass("transparan"))$(e.target).hasClass("active")?$(e.target).removeClass("active"):$(e.target).addClass("active"),$(this).find("fieldset#opacity").toggle();else if($(e.target).hasClass("legenda"))$(this).find("fieldset#legend").toggle();else if($(e.target).hasClass("visible"))$(this).find("div.control-right").toggle();else if($(e.target).hasClass("zoom")){zoomToExtent(findBy(map.getLayerGroup(),"id",$(e.target).attr("data-layer")))}}function createGroupLayer(){grouOpBJ=$.getValues("/map/getdata/group");for(var e=$("#layercontrol").find(".panel-body"),t=0;t<grouOpBJ.length;t++){_group=grouOpBJ[t];var a=document.createElement("button");a.setAttribute("class","layer-control"),a.append(_group.namalayer),e.append(a);var o=document.createElement("div");o.setAttribute("class","layer-control-panel panel"),o.setAttribute("id","layer-group-"+_group.id),a.addEventListener("click",function(){this.classList.toggle("active"),console.log(this.nextElementSibling);var e=this.nextElementSibling;e.style.maxHeight?e.style.maxHeight=null:e.style.maxHeight=e.scrollHeight+"px"});var r=document.createElement("ul");r.setAttribute("class","list-group"),r.setAttribute("id","list-group-"+_group.kodelayer.split(":")[1]),r.setAttribute("data-parentid",_group.id),r.setAttribute("data-kodegroup",_group.kodelayer),o.append(r),e.append(o)}}function changeInfoMap(e){infomap=e,console.log(infomap)}function zoomToExtent(r){var l,e=Laravel.geoserverUrl+"/wms?request=GetCapabilities&service=WMS&version=1.1.1",i=new ol.format.WMSCapabilities;$.ajax(e).then(function(e){for(var t=i.read(e).Capability.Layer.Layer,a=0,o=t.length;a<o;a++)if((l=t[a]).Name==r.get("id")){extent=l.BoundingBox[0].extent,coord1=ol.proj.transform([extent[1],extent[0]],"EPSG:4326","EPSG:3857"),coord2=ol.proj.transform([extent[2],extent[3]],"EPSG:4326","EPSG:3857"),console.log(extent),console.log(coord1),console.log(coord2),extent=ol.extent.boundingExtent([coord1],[coord2]),extent_=ol.proj.transformExtent(extent,r.get("srs"),"EPSG:3857"),console.log(r.get("srs"),extent),console.log(extent_),map.getView().fit(extent_,map.getSize());break}})}function resetFilter(){pureCoverage||($("#query-text").val(""),updateFilter())}function updateFilter(){if(!pureCoverage){var e=$("#query-text").val(),t={"geodata:poi_kota_bogor":"WHERE KATEGORI2 LIKE '%"+e+"%'","geodata:data_survei":"WHERE alamat LIKE '%"+e+"%' OR nama_survei LIKE '%"+e+"%' OR nama_objek LIKE '%"+e+"%' OR nama_jenis LIKE '%"+e+"%'","geodata:aset_kota_bogor":"WHERE alamat LIKE '%"+e+"%' OR nama_survei LIKE '%"+e+"%'"},a={FILTER:null,CQL_FILTER:null,FEATUREID:null};searchObject=findBy(map.getLayerGroup(),"id",selectedLayer),""!=e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")&&(a.CQL_FILTER=t[selectedLayer],console.log(a),searchObject.getSource().updateParams(a)),""==e&&(a.CQL_FILTER=null,searchObject.getSource().updateParams(a))}}function capital_varter(e){for(var t=0,a=(e=e.split(" ")).length;t<a;t++)e[t]=e[t][0].toUpperCase()+e[t].substr(1);return e.join(" ")}function view_streetview(e){var t=ol.proj.transform(e.coordinate,"EPSG:3857","EPSG:4326");new ol.style.Style({image:new ol.style.Icon({scale:.6,src:"img/pin_drop.png"}),text:new ol.style.Text({offsetY:25,text:ol.coordinate.format(t,"Coordinate is ({x} | {y})",2),font:"15px Open Sans,sans-serif",fill:new ol.style.Fill({color:"#111"}),stroke:new ol.style.Stroke({color:"#eee",width:2})})}),new ol.Feature({type:"removable",geometry:new ol.geom.Point(e.coordinate)});$("#formModalMap").find(".modal-title").html("Street View"),$("#street-view").css({height:"400px"}).appendTo($("#formModalMap").find(".modal-body")),$("#formModalMap").modal(),initializePanorama(t),console.log(t)}function OsOpenNamesSearch(e){var t=e.url;return{getParameters:function(e){return{url:t,callbackName:"callback",params:{q:e.query}}},handleResponse:function(e){return e&&e.features&&e.features.length?e.features.map(function(e){return{lon:e.geometry.coordinates[0],lat:e.geometry.coordinates[1],address:{name:e.properties.search_full},bbox:e.bbox}}):void 0}}}singleAllLayers=__root__;